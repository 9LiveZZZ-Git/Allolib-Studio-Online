# AlloLib Studio Online - Rendering Pipeline CI/CD
#
# Automated testing for WebGL2 and WebGPU rendering backends.
# Runs on every push and PR, with detailed error tracking.

name: Rendering Pipeline Tests

on:
  push:
    branches: [main, develop, 'feature/**']
    paths:
      - 'frontend/**'
      - 'backend/**'
      - 'allolib-wasm/**'
      - 'tests/**'
      - '.github/workflows/rendering-tests.yml'
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      backend:
        description: 'Backend to test'
        required: false
        default: 'both'
        type: choice
        options:
          - both
          - webgl2
          - webgpu
      debug:
        description: 'Enable debug mode'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20'
  DOCKER_BUILDKIT: 1

jobs:
  # ============================================================================
  # Build Stage
  # ============================================================================
  build:
    name: Build Application
    runs-on: ubuntu-latest
    outputs:
      build-success: ${{ steps.build.outcome == 'success' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            frontend/package-lock.json
            backend/package-lock.json

      - name: Install Frontend Dependencies
        working-directory: frontend
        run: npm ci

      - name: Install Backend Dependencies
        working-directory: backend
        run: npm ci

      - name: Build Frontend
        id: build
        working-directory: frontend
        run: npm run build

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist
          retention-days: 1

  # ============================================================================
  # WebGL2 Tests
  # ============================================================================
  test-webgl2:
    name: WebGL2 Rendering Tests
    needs: build
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.backend != 'webgpu' }}

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            frontend/package-lock.json
            backend/package-lock.json
            tests/package-lock.json

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist

      - name: Install Dependencies
        run: |
          cd frontend && npm ci
          cd ../backend && npm ci
          cd ../tests && npm ci

      - name: Install Playwright Browsers
        working-directory: tests
        run: npx playwright install chromium firefox --with-deps

      - name: Start Backend
        working-directory: backend
        run: |
          npm run dev &
          sleep 5
        env:
          REDIS_URL: redis://localhost:6379
          PORT: 4000

      - name: Start Frontend (Preview)
        working-directory: frontend
        run: |
          npm run preview &
          sleep 5

      - name: Run WebGL2 Tests
        working-directory: tests
        run: |
          npx playwright test --project=chromium-webgl2 --project=firefox-webgl2
        env:
          TEST_URL: http://localhost:4173
          BACKEND_URL: http://localhost:4000
          CI: true

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: webgl2-test-results
          path: |
            test-results/
            tests/test-results/
          retention-days: 7

      - name: Upload Error Report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: webgl2-error-report
          path: test-results/error-report.md
          retention-days: 30

  # ============================================================================
  # WebGPU Tests
  # ============================================================================
  test-webgpu:
    name: WebGPU Rendering Tests
    needs: build
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.backend != 'webgl2' }}

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: tests/package-lock.json

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist

      - name: Install Dependencies
        run: |
          cd frontend && npm ci
          cd ../backend && npm ci
          cd ../tests && npm ci

      - name: Install Playwright (Chromium with WebGPU)
        working-directory: tests
        run: npx playwright install chromium --with-deps

      - name: Start Services
        run: |
          cd backend && npm run dev &
          cd frontend && npm run preview &
          sleep 10
        env:
          REDIS_URL: redis://localhost:6379

      - name: Run WebGPU Tests
        working-directory: tests
        run: |
          npx playwright test --project=chromium-webgpu
        env:
          TEST_URL: http://localhost:4173
          BACKEND_URL: http://localhost:4000
          CI: true
        continue-on-error: true  # WebGPU tests may fail until fixes are applied

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: webgpu-test-results
          path: test-results/
          retention-days: 7

  # ============================================================================
  # Compilation Tests (No GPU Required)
  # ============================================================================
  test-compilation:
    name: WASM Compilation Tests
    needs: build
    runs-on: ubuntu-latest

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Emscripten Container
        run: |
          docker build -t allolib-compiler backend/docker/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Backend
        working-directory: backend
        run: npm ci

      - name: Run Compilation Tests
        working-directory: tests
        run: |
          npm ci
          npm run test:compilation
        env:
          REDIS_URL: redis://localhost:6379

      - name: Upload Compilation Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: compilation-results
          path: test-results/compilation/
          retention-days: 7

  # ============================================================================
  # Report Generation
  # ============================================================================
  generate-report:
    name: Generate Test Report
    needs: [test-webgl2, test-webgpu, test-compilation]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download All Results
        uses: actions/download-artifact@v4
        with:
          path: all-results

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Generate Combined Report
        run: |
          node tests/scripts/combine-reports.js all-results combined-report

      - name: Upload Combined Report
        uses: actions/upload-artifact@v4
        with:
          name: combined-test-report
          path: combined-report/
          retention-days: 30

      - name: Post Summary to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'combined-report/summary.md';

            if (fs.existsSync(reportPath)) {
              const summary = fs.readFileSync(reportPath, 'utf8');
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: summary
              });
            }

  # ============================================================================
  # Notify on Failure
  # ============================================================================
  notify-failure:
    name: Notify on Failure
    needs: [test-webgl2, test-webgpu]
    runs-on: ubuntu-latest
    if: failure()

    steps:
      - name: Create Issue on Failure
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ðŸš¨ Rendering Tests Failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `
            ## Rendering Pipeline Test Failure

            **Workflow Run:** [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            **Commit:** ${context.sha.substring(0, 7)}
            **Branch:** ${context.ref}

            ### Failed Jobs
            Check the workflow run for detailed error reports.

            ### Next Steps
            1. Download the error reports from the workflow artifacts
            2. Check the \`error-report.md\` for categorized errors
            3. Review console logs for WebGL/WebGPU specific issues

            /cc @${context.actor}
            `;

            // Check if similar issue exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'rendering-test-failure'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['rendering-test-failure', 'automated']
              });
            }
